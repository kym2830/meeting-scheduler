<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Group Meeting Scheduler</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.vote-indicator {
transition: all 0.3s ease;
}
.day-cell:hover {
transform: scale(1.02);
}
.selected-day {
animation: pulse 2s infinite;
}
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.8; }
}
.admin-button {
background: linear-gradient(135deg, #dc2626, #b91c1c);
transition: all 0.3s ease;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.admin-button:hover {
background: linear-gradient(135deg, #b91c1c, #991b1b);
transform: translateY(-1px);
box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
}
.admin-panel {
background: linear-gradient(135deg, #fef2f2, #fee2e2);
border: 3px solid #fca5a5;
}
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
<div class="max-w-6xl mx-auto">
<!-- Header -->
<div class="text-center mb-8">
<h1 class="text-4xl font-bold text-gray-800 mb-2">Group Meeting Scheduler</h1>
<p class="text-gray-600 text-lg">Vote for your preferred meeting days</p>
</div>

<!-- Admin Panel (Hidden by default) -->
<div id="adminPanel" class="admin-panel rounded-xl shadow-2xl p-8 mb-6 hidden">
<div class="flex justify-between items-center mb-6">
<div class="flex items-center gap-3">
<div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
<span class="text-white text-2xl">üîí</span>
</div>
<div>
<h2 class="text-3xl font-bold text-red-800">Admin Control Panel</h2>
<p class="text-red-600 font-medium">Steven's Availability Management</p>
</div>
</div>
<button id="exitAdminBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all shadow-lg">
Exit Admin Mode
</button>
</div>

<!-- Admin Actions Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
<!-- Clear Availability -->
<div class="bg-white rounded-xl p-6 shadow-lg border-2 border-orange-200">
<div class="text-center mb-4">
<div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
<span class="text-3xl">üóëÔ∏è</span>
</div>
<h3 class="font-bold text-gray-800 mb-2">Clear Availability</h3>
<p class="text-sm text-gray-600 mb-4">Remove all of Steven's available time slots</p>
</div>
<button id="clearAvailBtn" class="w-full admin-button text-white px-4 py-3 rounded-lg font-bold">
Clear All Availability
</button>
</div>

<!-- Clear Votes -->
<div class="bg-white rounded-xl p-6 shadow-lg border-2 border-yellow-200">
<div class="text-center mb-4">
<div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
<span class="text-3xl">üßπ</span>
</div>
<h3 class="font-bold text-gray-800 mb-2">Clear Client Votes</h3>
<p class="text-sm text-gray-600 mb-4">Remove all client voting data</p>
</div>
<button id="clearVotesBtn" class="w-full admin-button text-white px-4 py-3 rounded-lg font-bold">
Clear All Votes
</button>
</div>

<!-- Lock Calendar -->
<div class="bg-white rounded-xl p-6 shadow-lg border-2 border-purple-200">
<div class="text-center mb-4">
<div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
<span class="text-3xl" id="lockIcon">üîì</span>
</div>
<h3 class="font-bold text-gray-800 mb-2">Calendar Access</h3>
<p class="text-sm text-gray-600 mb-4" id="lockDescription">Allow client voting</p>
</div>
<button id="lockCalendarBtn" class="w-full admin-button text-white px-4 py-3 rounded-lg font-bold">
Lock Calendar
</button>
</div>

<!-- Admin Stats -->
<div class="bg-white rounded-xl p-6 shadow-lg border-2 border-blue-200">
<div class="text-center mb-4">
<div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
<span class="text-3xl">üìä</span>
</div>
<h3 class="font-bold text-gray-800 mb-2">Quick Stats</h3>
<div class="text-sm text-gray-600">
<div id="availableDays">Available Days: 0</div>
<div id="totalVotes">Total Votes: 0</div>
<div id="uniqueVoters">Unique Voters: 0</div>
</div>
</div>
</div>
</div>

<!-- Admin Instructions -->
<div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
<h4 class="font-bold text-red-800 mb-2">üìã Admin Instructions</h4>
<ul class="text-red-700 text-sm space-y-1">
<li>‚Ä¢ Click calendar days to set Steven's available time slots</li>
<li>‚Ä¢ Only available days will be shown to clients for voting</li>
<li>‚Ä¢ Use "Lock Calendar" to prevent further client voting</li>
<li>‚Ä¢ Clear functions are permanent - use with caution!</li>
</ul>
</div>
</div>

<!-- Client Name Input -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
<div id="lockedMessage" class="text-center p-4 bg-gray-100 rounded-lg mb-4 hidden">
<p class="text-gray-700 font-semibold">üìÖ Calendar is currently locked for updates</p>
</div>
<div class="flex flex-col sm:flex-row gap-4 items-center justify-center mb-4">
<label class="text-lg font-semibold text-gray-700">Your Name:</label>
<input type="text" id="clientName" placeholder="Enter your name"
class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg">
<button onclick="setClientName()"
class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
Set Name
</button>
</div>
<div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
<label class="text-lg font-semibold text-gray-700">Timezone:</label>
<div class="flex gap-2">
<button id="pstBtn" onclick="setTimezone('PST')"
class="px-4 py-2 border-2 rounded-lg font-semibold transition-colors bg-blue-600 border-blue-600 text-white">
PST
</button>
<button id="cstBtn" onclick="setTimezone('CST')"
class="px-4 py-2 border-2 rounded-lg font-semibold transition-colors bg-gray-200 border-gray-300 text-gray-700 hover:bg-gray-300">
CST
</button>
<button id="estBtn" onclick="setTimezone('EST')"
class="px-4 py-2 border-2 rounded-lg font-semibold transition-colors bg-gray-200 border-gray-300 text-gray-700 hover:bg-gray-300">
EST
</button>
</div>
</div>
<div id="currentClient" class="text-center mt-4 text-lg font-medium text-blue-600"></div>
</div>

<!-- Calendar -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
<div class="flex justify-between items-center mb-6">
<button onclick="previousMonth()"
class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-semibold transition-colors">
‚Üê Previous
</button>
<h2 id="monthYear" class="text-2xl font-bold text-gray-800"></h2>
<button onclick="nextMonth()"
class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-semibold transition-colors">
Next ‚Üí
</button>
</div>

<div class="grid grid-cols-7 gap-2 mb-4">
<div class="text-center font-semibold text-gray-600 py-2">Sun</div>
<div class="text-center font-semibold text-gray-600 py-2">Mon</div>
<div class="text-center font-semibold text-gray-600 py-2">Tue</div>
<div class="text-center font-semibold text-gray-600 py-2">Wed</div>
<div class="text-center font-semibold text-gray-600 py-2">Thu</div>
<div class="text-center font-semibold text-gray-600 py-2">Fri</div>
<div class="text-center font-semibold text-gray-600 py-2">Sat</div>
</div>

<div id="calendar" class="grid grid-cols-7 gap-2"></div>
</div>

<!-- Legend -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">How to Use</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<h4 class="font-semibold text-gray-700 mb-2">Calendar Colors:</h4>
<div id="colorLegend" class="space-y-2">
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-green-200 border-2 border-green-400 rounded"></div>
<span class="text-gray-700">Some votes</span>
</div>
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-green-300 border-2 border-green-500 rounded"></div>
<span class="text-gray-700">Most votes</span>
</div>
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-green-400 border-2 border-green-600 rounded"></div>
<span class="text-gray-700">All voters agree</span>
</div>
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-blue-200 border-2 border-blue-400 rounded"></div>
<span class="text-gray-700">You voted here</span>
</div>
</div>
</div>
<div>
<h4 class="font-semibold text-gray-700 mb-2">Instructions:</h4>
<ol class="text-sm text-gray-600 space-y-1">
<li>1. Enter your name and select timezone</li>
<li>2. Click on any future date</li>
<li>3. Select your preferred time slots</li>
<li>4. Click "Save Votes" to confirm</li>
<li>5. Check "Best Meeting Times" for results!</li>
</ol>
</div>
</div>
</div>

<!-- Time Selection Modal -->
<div id="timeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
<div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
<div class="flex justify-between items-center mb-4">
<h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
<button onclick="closeTimeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
</div>
<p id="modalDescription" class="text-gray-600 mb-4">Select your preferred time slots:</p>
<div id="timeSlots" class="grid grid-cols-3 gap-2 mb-6"></div>
<div class="flex gap-3">
<button id="saveButton" onclick="saveTimeVotes()"
class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
Save Votes
</button>
<button onclick="closeTimeModal()"
class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors">
Cancel
</button>
</div>
</div>
</div>

<!-- Voting Summary -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">Voting Summary</h3>
<div id="votingSummary" class="space-y-2"></div>
</div>

<!-- Best Meeting Times -->
<div class="bg-white rounded-xl shadow-lg p-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">üéØ Best Meeting Times</h3>
<div id="bestTimes" class="space-y-2"></div>
</div>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAYQOa7O99rNerbM7j-ud9YBcOyj75acn4",
    authDomain: "group-meeting-scheduler.firebaseapp.com",
    projectId: "group-meeting-scheduler",
    storageBucket: "group-meeting-scheduler.firebasestorage.app",
    messagingSenderId: "480029247223",
    appId: "1:480029247223:web:67ccd1d7a33282b4b635f2"
  };

  // Initialize Firebase and Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const schedulerDocRef = doc(db, "scheduler", "data");

 let currentDate = new Date();
let currentClient = '';
let votes = {}; // Structure: { "2024-01-15": { "09:00": ["Alice", "Bob"], "14:00": ["Alice"] }, ... }
let selectedDate = null;
let currentTimezone = 'PST';
let adminMode = false;
let adminAvailability = {}; // Structure: { "2024-01-15": ["09:00", "14:00"], ... }
let calendarLocked = false;

async function updateDatabase() {
  try {
    await setDoc(schedulerDocRef, {
      votes: votes,
      adminAvailability: adminAvailability,
      calendarLocked: calendarLocked
    });
    console.log("Database updated successfully!");
  } catch (error) {
    console.error("Error updating database: ", error);
    alert("Could not save changes to the server. Please check your connection and try again.");
  }
}

// Time slots in 24-hour format for internal use
let baseTimeSlots = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];

function formatTimeForDisplay(time24) {
const [hours, minutes] = time24.split(':');
const hour = parseInt(hours);
const ampm = hour >= 12 ? 'PM' : 'AM';
const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
return `${displayHour}:${minutes} ${ampm}`;
}

function getTimezoneOffset(timezone) {
const offsets = { 'PST': 0, 'CST': 2, 'EST': 3 };
return offsets[timezone] || 0;
}

function convertTimeToTimezone(time24, fromTz, toTz) {
const [hours, minutes] = time24.split(':');
let hour = parseInt(hours);
const offset = getTimezoneOffset(toTz) - getTimezoneOffset(fromTz);
hour += offset;

// Handle day overflow/underflow
if (hour >= 24) hour -= 24;
if (hour < 0) hour += 24;

return `${hour.toString().padStart(2, '0')}:${minutes}`;
}

function getDisplayTimeSlots() {
return baseTimeSlots.map(time => ({
internal: time,
display: formatTimeForDisplay(convertTimeToTimezone(time, 'PST', currentTimezone))
}));
}

function setClientName() {
const nameInput = document.getElementById('clientName');
const name = nameInput.value.trim();
if (name) {
currentClient = name;
document.getElementById('currentClient').textContent = `Voting as: ${name}`;
nameInput.value = '';
updateColorLegend();
} else {
alert('Please enter your name');
}
}

function setTimezone(timezone) {
currentTimezone = timezone;

// Update button styles
const buttons = ['pstBtn', 'cstBtn', 'estBtn'];
buttons.forEach(btnId => {
const btn = document.getElementById(btnId);
if (btnId === timezone.toLowerCase() + 'Btn') {
btn.className = 'px-4 py-2 border-2 rounded-lg font-semibold transition-colors bg-blue-600 border-blue-600 text-white';
} else {
btn.className = 'px-4 py-2 border-2 rounded-lg font-semibold transition-colors bg-gray-200 border-gray-300 text-gray-700 hover:bg-gray-300';
}
});

// Refresh any open modal
if (selectedDate && !document.getElementById('timeModal').classList.contains('hidden')) {
const date = new Date(selectedDate + 'T00:00:00');
openTimeModal(selectedDate, date);
}
}

function updateColorLegend() {
const allVoters = new Set();
Object.values(votes).forEach(dayVotes => {
Object.values(dayVotes).forEach(voters => {
voters.forEach(voter => allVoters.add(voter));
});
});

const totalVoters = allVoters.size;
const colorLegend = document.getElementById('colorLegend');

// Check if there's any time slot where 100% of voters agree
let hasFullAgreement = false;
if (totalVoters > 0) {
Object.values(votes).forEach(dayVotes => {
Object.values(dayVotes).forEach(voters => {
if (voters.length === totalVoters) {
hasFullAgreement = true;
}
});
});
}

colorLegend.innerHTML = `
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-blue-200 border-2 border-blue-400 rounded"></div>
<span class="text-gray-700">Available for meetings</span>
</div>
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-green-200 border-2 border-green-400 rounded"></div>
<span class="text-gray-700">Some votes</span>
</div>
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-green-300 border-2 border-green-500 rounded"></div>
<span class="text-gray-700">Most votes</span>
</div>
${hasFullAgreement ? `
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-green-400 border-2 border-green-600 rounded"></div>
<span class="text-gray-700">All voters agree</span>
</div>
` : ''}
`;
}

function updateAdminStats() {
if (!adminMode) return;

// Count available days
const availableDaysCount = Object.keys(adminAvailability).length;
document.getElementById('availableDays').textContent = `Available Days: ${availableDaysCount}`;

// Count total votes
let totalVotesCount = 0;
Object.values(votes).forEach(dayVotes => {
Object.values(dayVotes).forEach(voters => {
totalVotesCount += voters.length;
});
});
document.getElementById('totalVotes').textContent = `Total Votes: ${totalVotesCount}`;

// Count unique voters
const uniqueVoters = new Set();
Object.values(votes).forEach(dayVotes => {
Object.values(dayVotes).forEach(voters => {
voters.forEach(voter => uniqueVoters.add(voter));
});
});
document.getElementById('uniqueVoters').textContent = `Unique Voters: ${uniqueVoters.size}`;
}

function generateCalendar() {
const calendar = document.getElementById('calendar');
const monthYear = document.getElementById('monthYear');

const year = currentDate.getFullYear();
const month = currentDate.getMonth();

monthYear.textContent = currentDate.toLocaleDateString('en-US', {
month: 'long',
year: 'numeric'
});

const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const startDate = new Date(firstDay);
startDate.setDate(startDate.getDate() - firstDay.getDay());

calendar.innerHTML = '';

for (let i = 0; i < 42; i++) {
const cellDate = new Date(startDate);
cellDate.setDate(startDate.getDate() + i);

const dateStr = cellDate.toISOString().split('T')[0];
const isCurrentMonth = cellDate.getMonth() === month;
const isPastDate = cellDate < new Date().setHours(0, 0, 0, 0);
const dayVotes = votes[dateStr] || {};
const totalVotes = Object.values(dayVotes).reduce((sum, voters) => sum + voters.length, 0);
const hasUserVote = Object.values(dayVotes).some(voters => voters.includes(currentClient));

const cell = document.createElement('div');
cell.className = `day-cell relative p-2 h-16 border-2 rounded-lg cursor-pointer transition-all ${
isCurrentMonth ? 'border-gray-200' : 'border-gray-100 text-gray-400'
} ${isPastDate ? 'bg-gray-100 cursor-not-allowed' : 'hover:border-blue-300'}`;

if (!isPastDate && isCurrentMonth) {
// Admin mode: show Steven's availability in red
if (adminMode && adminAvailability[dateStr] && adminAvailability[dateStr].length > 0) {
cell.className += ' bg-red-200 border-red-400';
}
// Regular mode: show Steven's availability in blue, voting colors in green
else if (!adminMode) {
// Show Steven's availability in blue for clients
if (adminAvailability[dateStr] && adminAvailability[dateStr].length > 0) {
cell.className += ' bg-blue-200 border-blue-400';
}

// Show voting intensity in green shades
if (totalVotes > 0) {
// Get total number of unique voters
const allVoters = new Set();
Object.values(votes).forEach(dayVotes => {
Object.values(dayVotes).forEach(voters => {
voters.forEach(voter => allVoters.add(voter));
});
});
const totalUniqueVoters = allVoters.size;

if (totalUniqueVoters > 0) {
// Check if any time slot on this day has 100% agreement
let hasFullAgreementThisDay = false;
Object.values(dayVotes).forEach(voters => {
if (voters.length === totalUniqueVoters) {
hasFullAgreementThisDay = true;
}
});

if (hasFullAgreementThisDay) {
cell.className = cell.className.replace('bg-blue-200 border-blue-400', 'bg-green-400 border-green-600');
} else {
// Calculate proportion of voters who voted for this day
const votersForThisDay = new Set();
Object.values(dayVotes).forEach(voters => {
voters.forEach(voter => votersForThisDay.add(voter));
});
const proportionVoted = votersForThisDay.size / totalUniqueVoters;

if (proportionVoted >= 0.67) { // Most voters (67%+)
cell.className = cell.className.replace('bg-blue-200 border-blue-400', 'bg-green-300 border-green-500');
} else { // Some voters (less than 67%)
cell.className = cell.className.replace('bg-blue-200 border-blue-400', 'bg-green-200 border-green-400');
}
}
}
}

// Add special indicator if current user has voted on this day
if (hasUserVote) {
cell.classList.add('selected-day');
}
}
}

cell.innerHTML = `
<div class="text-sm font-semibold">${cellDate.getDate()}</div>
${totalVotes > 0 ? `<div class="vote-indicator absolute bottom-1 right-1 bg-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold text-gray-700">${totalVotes}</div>` : ''}
`;

if (!isPastDate && isCurrentMonth) {
if (adminMode) {
cell.onclick = () => openTimeModal(dateStr, cellDate);
} else if (!calendarLocked) {
// Only allow client voting if Steven has set availability for this date
if (adminAvailability[dateStr] && adminAvailability[dateStr].length > 0) {
cell.onclick = () => openTimeModal(dateStr, cellDate);
} else {
cell.onclick = () => alert('This date is not available for meetings.');
cell.className += ' opacity-50 cursor-not-allowed';
}
} else {
cell.onclick = () => alert('Calendar is currently locked for updates.');
cell.className += ' opacity-75 cursor-not-allowed';
}
}

calendar.appendChild(cell);
}

updateVotingSummary();
updateAdminStats();
}

function openTimeModal(dateStr, date) {
if (!adminMode && !currentClient) {
alert('Please set your name first');
return;
}

selectedDate = dateStr;
const dateDisplay = date.toLocaleDateString('en-US', {
weekday: 'long',
month: 'long',
day: 'numeric'
});

document.getElementById('modalTitle').textContent = dateDisplay;

// Update modal content based on admin mode
if (adminMode) {
document.getElementById('modalDescription').textContent = 'Set Steven\'s available time slots:';
document.getElementById('saveButton').textContent = 'Save Availability';
document.getElementById('saveButton').className = 'flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors';
} else {
document.getElementById('modalDescription').textContent = 'Select your preferred time slots:';
document.getElementById('saveButton').textContent = 'Save Votes';
document.getElementById('saveButton').className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors';
}

const timeSlotsContainer = document.getElementById('timeSlots');
timeSlotsContainer.innerHTML = '';

const displayTimeSlots = getDisplayTimeSlots();

displayTimeSlots.forEach(timeSlot => {
let isSelected, voteCount, isAvailable;

if (adminMode) {
// Admin mode: show Steven's availability
isSelected = adminAvailability[dateStr] && adminAvailability[dateStr].includes(timeSlot.internal);
voteCount = votes[dateStr] && votes[dateStr][timeSlot.internal] ? votes[dateStr][timeSlot.internal].length : 0;
isAvailable = true;
} else {
// Client mode: only show available times
isAvailable = adminAvailability[dateStr] && adminAvailability[dateStr].includes(timeSlot.internal);
if (!isAvailable) return; // Skip unavailable times

isSelected = votes[dateStr] && votes[dateStr][timeSlot.internal] && votes[dateStr][timeSlot.internal].includes(currentClient);
voteCount = votes[dateStr] && votes[dateStr][timeSlot.internal] ? votes[dateStr][timeSlot.internal].length : 0;
}

const timeButton = document.createElement('button');
timeButton.className = `p-3 rounded-lg border-2 transition-all text-sm font-semibold ${
isSelected
? (adminMode ? 'bg-red-200 border-red-400 text-red-800' : 'bg-blue-200 border-blue-400 text-blue-800')
: 'bg-gray-50 border-gray-200 hover:border-blue-300 text-gray-700'
}`;
timeButton.innerHTML = `
<div>${timeSlot.display}</div>
${voteCount > 0 && adminMode ? `<div class="text-xs mt-1">${voteCount} vote${voteCount !== 1 ? 's' : ''}</div>` : ''}
${voteCount > 0 && !adminMode ? `<div class="text-xs mt-1">${voteCount} vote${voteCount !== 1 ? 's' : ''}</div>` : ''}
`;
timeButton.onclick = () => toggleTimeSlot(timeSlot.internal, timeButton, timeSlot.display);
timeSlotsContainer.appendChild(timeButton);
});

document.getElementById('timeModal').classList.remove('hidden');
}

function toggleTimeSlot(time, button, displayTime) {
if (adminMode) {
// Admin mode: toggle Steven's availability
if (!adminAvailability[selectedDate]) {
adminAvailability[selectedDate] = [];
}

const timeIndex = adminAvailability[selectedDate].indexOf(time);
if (timeIndex > -1) {
adminAvailability[selectedDate].splice(timeIndex, 1);
if (adminAvailability[selectedDate].length === 0) {
delete adminAvailability[selectedDate];
}
button.className = 'p-3 rounded-lg border-2 transition-all text-sm font-semibold bg-gray-50 border-gray-200 hover:border-blue-300 text-gray-700';
} else {
adminAvailability[selectedDate].push(time);
button.className = 'p-3 rounded-lg border-2 transition-all text-sm font-semibold bg-red-200 border-red-400 text-red-800';
}

// Update display with vote count
const voteCount = votes[selectedDate] && votes[selectedDate][time] ? votes[selectedDate][time].length : 0;
button.innerHTML = `
<div>${displayTime}</div>
${voteCount > 0 ? `<div class="text-xs mt-1">${voteCount} vote${voteCount !== 1 ? 's' : ''}</div>` : ''}
`;
} else {
// Client mode: toggle votes
if (!votes[selectedDate]) {
votes[selectedDate] = {};
}
if (!votes[selectedDate][time]) {
votes[selectedDate][time] = [];
}

const userIndex = votes[selectedDate][time].indexOf(currentClient);
if (userIndex > -1) {
votes[selectedDate][time].splice(userIndex, 1);
if (votes[selectedDate][time].length === 0) {
delete votes[selectedDate][time];
}
button.className = 'p-3 rounded-lg border-2 transition-all text-sm font-semibold bg-gray-50 border-gray-200 hover:border-blue-300 text-gray-700';
} else {
votes[selectedDate][time].push(currentClient);
button.className = 'p-3 rounded-lg border-2 transition-all text-sm font-semibold bg-blue-200 border-blue-400 text-blue-800';
}

// Update vote count display
const voteCount = votes[selectedDate][time] ? votes[selectedDate][time].length : 0;
button.innerHTML = `
<div>${displayTime}</div>
${voteCount > 0 ? `<div class="text-xs mt-1">${voteCount} vote${voteCount !== 1 ? 's' : ''}</div>` : ''}
`;
}
}

async function saveTimeVotes() {
// Clean up empty date entries
if (votes[selectedDate] && Object.keys(votes[selectedDate]).length === 0) {
delete votes[selectedDate];
}

await updateDatabase();
closeTimeModal();
generateCalendar();
updateColorLegend();
}

function closeTimeModal() {
document.getElementById('timeModal').classList.add('hidden');
selectedDate = null;
}

function updateVotingSummary() {
const summary = document.getElementById('votingSummary');
const bestTimes = document.getElementById('bestTimes');
const sortedDates = Object.keys(votes).sort();

if (sortedDates.length === 0) {
summary.innerHTML = '<p class="text-gray-500">No votes yet. Click on calendar days to vote for specific times!</p>';
bestTimes.innerHTML = '<p class="text-gray-500">Vote for times to see the best meeting options!</p>';
return;
}

// Generate voting summary
summary.innerHTML = sortedDates.map(dateStr => {
const date = new Date(dateStr + 'T00:00:00');
const dayVotes = votes[dateStr];
const dateDisplay = date.toLocaleDateString('en-US', {
weekday: 'long',
month: 'long',
day: 'numeric'
});

const timeSlotSummary = Object.entries(dayVotes).map(([time, voters]) => {
const displayTime = formatTimeForDisplay(convertTimeToTimezone(time, 'PST', currentTimezone));
return `${displayTime} (${voters.length}: ${voters.join(', ')})`;
}).join(' ‚Ä¢ ');

const totalVotes = Object.values(dayVotes).reduce((sum, voters) => sum + voters.length, 0);

return `
<div class="p-4 bg-gray-50 rounded-lg">
<div class="flex justify-between items-center mb-2">
<span class="font-semibold text-gray-800">${dateDisplay}</span>
<span class="text-sm text-gray-600">${totalVotes} total vote${totalVotes !== 1 ? 's' : ''}</span>
</div>
<div class="text-sm text-gray-600">${timeSlotSummary}</div>
</div>
`;
}).join('');

// Generate best meeting times analysis
const allTimeSlots = [];
Object.entries(votes).forEach(([dateStr, dayVotes]) => {
Object.entries(dayVotes).forEach(([time, voters]) => {
allTimeSlots.push({
date: dateStr,
time: time,
voters: voters,
count: voters.length
});
});
});

// Sort by vote count (descending) and then by date
allTimeSlots.sort((a, b) => {
if (b.count !== a.count) return b.count - a.count;
return a.date.localeCompare(b.date);
});

if (allTimeSlots.length === 0) {
bestTimes.innerHTML = '<p class="text-gray-500">No time slots voted for yet!</p>';
return;
}

const topSlots = allTimeSlots.slice(0, 5); // Show top 5
bestTimes.innerHTML = topSlots.map((slot, index) => {
const date = new Date(slot.date + 'T00:00:00');
const dateDisplay = date.toLocaleDateString('en-US', {
weekday: 'short',
month: 'short',
day: 'numeric'
});

const displayTime = formatTimeForDisplay(convertTimeToTimezone(slot.time, 'PST', currentTimezone));
const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '‚≠ê';

return `
<div class="flex items-center justify-between p-4 bg-gradient-to-r ${
index === 0 ? 'from-yellow-50 to-yellow-100 border-yellow-300' :
index === 1 ? 'from-gray-50 to-gray-100 border-gray-300' :
index === 2 ? 'from-orange-50 to-orange-100 border-orange-300' :
'from-blue-50 to-blue-100 border-blue-300'
} border-2 rounded-lg">
<div class="flex items-center gap-3">
<span class="text-2xl">${medal}</span>
<div>
<div class="font-semibold text-gray-800">${dateDisplay} at ${displayTime}</div>
<div class="text-sm text-gray-600">${slot.voters.join(', ')}</div>
</div>
</div>
<div class="text-right">
<div class="font-bold text-lg text-gray-800">${slot.count}</div>
<div class="text-xs text-gray-500">vote${slot.count !== 1 ? 's' : ''}</div>
</div>
</div>
`;
}).join('');
}

function toggleAdminMode() {
adminMode = !adminMode;
const adminPanel = document.getElementById('adminPanel');

if (adminMode) {
adminPanel.classList.remove('hidden');
currentClient = 'Steven (Admin)';
document.getElementById('currentClient').textContent = 'Admin Mode: Setting Steven\'s Availability';
document.getElementById('currentClient').className = 'text-center mt-4 text-lg font-medium text-red-600';
} else {
adminPanel.classList.add('hidden');
currentClient = '';
document.getElementById('currentClient').textContent = '';
document.getElementById('currentClient').className = 'text-center mt-4 text-lg font-medium text-blue-600';
}

generateCalendar();
updateColorLegend();
}

function exitAdminMode() {
adminMode = false;
document.getElementById('adminPanel').classList.add('hidden');
currentClient = '';
document.getElementById('currentClient').textContent = '';
document.getElementById('currentClient').className = 'text-center mt-4 text-lg font-medium text-blue-600';
generateCalendar();
updateColorLegend();
}

async function handleClearAvailability() {
if (confirm('‚ö†Ô∏è CLEAR ALL AVAILABILITY\n\nThis will permanently remove all of Steven\'s available time slots. Clients will no longer be able to vote for any dates.\n\nThis action cannot be undone. Are you sure?')) {
adminAvailability = {};
await updateDatabase();
generateCalendar();
alert('‚úÖ Steven\'s availability has been completely cleared.');
}
}

async function handleClearVotes() {
if (confirm('‚ö†Ô∏è CLEAR ALL CLIENT VOTES\n\nThis will permanently delete all client voting data and reset the voting summary.\n\nThis action cannot be undone. Are you sure?')) {
votes = {};
await updateDatabase();
generateCalendar();
updateColorLegend();
alert('‚úÖ All client votes have been cleared.');
}
}

async function handleToggleLock() {
calendarLocked = !calendarLocked;
const lockButton = document.getElementById('lockCalendarBtn');
const lockIcon = document.getElementById('lockIcon');
const lockDescription = document.getElementById('lockDescription');
const lockedMessage = document.getElementById('lockedMessage');

if (calendarLocked) {
lockButton.textContent = 'Unlock Calendar';
lockButton.className = 'w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-bold transition-all';
lockIcon.textContent = 'üîí';
lockDescription.textContent = 'Calendar is locked';
lockedMessage.classList.remove('hidden');
} else {
lockButton.textContent = 'Lock Calendar';
lockButton.className = 'w-full admin-button text-white px-4 py-3 rounded-lg font-bold';
lockIcon.textContent = 'üîì';
lockDescription.textContent = 'Allow client voting';
lockedMessage.classList.add('hidden');
}
await updateDatabase();
}

function previousMonth() {
currentDate.setMonth(currentDate.getMonth() - 1);
generateCalendar();
}

function nextMonth() {
currentDate.setMonth(currentDate.getMonth() + 1);
generateCalendar();
}

// Keyboard shortcut for admin mode (Ctrl + Shift + A)
document.addEventListener('keydown', function(event) {
if (event.ctrlKey && event.shiftKey && event.key === 'A') {
event.preventDefault();
toggleAdminMode();
}
});

// NEW ASYNCHRONOUS LISTENER TO LOAD DATA
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const docSnap = await getDoc(schedulerDocRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      // Load data from Firestore into your local variables
      votes = data.votes || {};
      adminAvailability = data.adminAvailability || {};
      calendarLocked = data.calendarLocked || false;
      console.log("Data loaded from Firestore.");
    } else {
      // This will run only if the document doesn't exist in Firestore yet.
      console.log("No document found! Initializing a new one.");
      await updateDatabase(); // Create the initial document in the database
    }
  } catch (error) {
    console.error("Error loading data from Firestore: ", error);
    alert("Could not load schedule data. Please check your connection and refresh the page.");
  }

  // Now that data is loaded, generate the calendar and set up listeners
  generateCalendar();
  updateColorLegend(); // Update legend based on loaded data

  // Set initial lock state from the database
  const lockButton = document.getElementById('lockCalendarBtn');
  const lockIcon = document.getElementById('lockIcon');
  const lockDescription = document.getElementById('lockDescription');
  const lockedMessage = document.getElementById('lockedMessage');

  if (calendarLocked) {
    lockButton.textContent = 'Unlock Calendar';
    lockButton.className = 'w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-bold transition-all';
    lockIcon.textContent = 'Ô£ø√º√Æ√≠';
    lockDescription.textContent = 'Calendar is locked';
    lockedMessage.classList.remove('hidden');
  }

  // Use event delegation for all admin panel actions
  const adminPanel = document.getElementById('adminPanel');
  if (adminPanel) {
      adminPanel.addEventListener('click', function(event) {
          const button = event.target.closest('button');
          if (!button) return;

          switch (button.id) {
              case 'exitAdminBtn':
                  exitAdminMode();
                  break;
              case 'clearAvailBtn':
                  handleClearAvailability();
                  break;
              case 'clearVotesBtn':
                  handleClearVotes();
                  break;
              case 'lockCalendarBtn':
                  handleToggleLock();
                  break;
          }
      });
  }
});

</script>
</body>
</html>